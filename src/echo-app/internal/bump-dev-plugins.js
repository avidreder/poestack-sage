'use strict'
const fs = require('fs')
const path = require('path')

function getPluginPackageNames(parentDir) {
  const plugins = []
  fs.readdirSync(parentDir).map(function (file) {
    let dir = path.resolve(parentDir, file)
    if (fs.statSync(dir).isDirectory()) {
      plugins.push(file)
    }
  })
  return plugins
}

const echoPluginExamples = getPluginPackageNames(path.resolve('..', 'echo-plugin-examples'))
const echoPlugins = getPluginPackageNames(path.resolve('..', 'echo-plugins'))
const packageJson = JSON.parse(fs.readFileSync(path.resolve('package.json')).toString())
const allPlugins = [...echoPluginExamples, ...echoPlugins]
const echoAppDeps = Object.keys(packageJson.dependencies)
const allActivePlugins = allPlugins.filter((plugin) => echoAppDeps.includes(plugin))

fs.writeFileSync(
  path.resolve('src', 'renderer', 'src', 'dev-plugins.ts'),
  `/**
  * **************************************************************
  * **********************AUTOGENERATED FILE**********************
  * **************************************************************
  * 
  * This plugins are used in dev mode - via 'npm run dev'
  * All of these plugins have HMR enabled, regardless of whether you only have the plugins folder open
  */
export const DEV_PLUGINS = [
  ${allActivePlugins.map((plugin) => `// @ts-ignore\n\timport('${plugin}')`).join(',\n  ')}
]`
)
